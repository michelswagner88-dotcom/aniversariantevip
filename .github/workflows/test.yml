name: Tests & Security Checks
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Run all tests
        id: tests
        run: npm run test
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
        continue-on-error: true

      - name: Run security-specific tests
        id: security_tests
        run: npm run test:security
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
        continue-on-error: true

      - name: Generate coverage report
        id: coverage
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: steps.coverage.outcome == 'success'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Set results summary
        id: summary
        run: |
          LINT_STATUS="${{ steps.lint.outcome }}"
          TESTS_STATUS="${{ steps.tests.outcome }}"
          SECURITY_STATUS="${{ steps.security_tests.outcome }}"

          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "tests_status=$TESTS_STATUS" >> $GITHUB_OUTPUT
          echo "security_status=$SECURITY_STATUS" >> $GITHUB_OUTPUT

          if [ "$LINT_STATUS" == "success" ] && [ "$TESTS_STATUS" == "success" ] && [ "$SECURITY_STATUS" == "success" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.summary.outputs.lint_status }}';
            const testsStatus = '${{ steps.summary.outputs.tests_status }}';
            const securityStatus = '${{ steps.summary.outputs.security_status }}';
            const allPassed = '${{ steps.summary.outputs.all_passed }}' === 'true';

            const getEmoji = (status) => status === 'success' ? 'âœ…' : 'âŒ';

            let comment = '## ğŸ§ª Resultados dos Testes\n\n';

            comment += '| Check | Status |\n';
            comment += '|-------|--------|\n';
            comment += `| Linting | ${getEmoji(lintStatus)} ${lintStatus} |\n`;
            comment += `| Testes | ${getEmoji(testsStatus)} ${testsStatus} |\n`;
            comment += `| SeguranÃ§a | ${getEmoji(securityStatus)} ${securityStatus} |\n\n`;

            if (allPassed) {
              comment += '### âœ… Todos os checks passaram!\n\n';
            } else {
              comment += '### âš ï¸ Alguns checks falharam\n\n';
              comment += 'Verifique os logs para mais detalhes.\n\n';
            }

            comment += `ğŸ“Š [Ver execuÃ§Ã£o completa](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
            comment += `---\n_Executado em: ${new Date().toISOString()}_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if critical tests failed
        if: steps.tests.outcome == 'failure' || steps.security_tests.outcome == 'failure'
        run: |
          echo "âŒ Testes crÃ­ticos falharam!"
          echo "Testes: ${{ steps.tests.outcome }}"
          echo "SeguranÃ§a: ${{ steps.security_tests.outcome }}"
          exit 1
